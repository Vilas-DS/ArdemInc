<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extraction Results</title>

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    html { font-size: 70%; }
    body { font-family: 'Inter', sans-serif; }
    .thumbnail {
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }
    .thumbnail.active {
      border-color: #3b82f6; /* blue-500 */
    }
  </style>

  <script>
    // Apply saved theme before rendering
    if (
      localStorage.getItem("theme") === "dark" ||
      (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    }
  </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

  <!-- Loading State -->
  <div id="loading" class="flex justify-center items-center h-screen">
    <div class="text-center">
      <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 
             5.291A7.962 7.962 0 014 12H0c0 
             3.042 1.135 5.824 3 7.938l3-2.647z">
        </path>
      </svg>
      <p class="mt-2 text-lg">Loading Results...</p>
    </div>
  </div>

  <!-- Error Container -->
  <div id="error-container" class="hidden container mx-auto p-8">
    <div class="my-6 p-4 bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 rounded-lg">
      <h2 class="font-bold">Error</h2>
      <p id="error-message" class="whitespace-pre-wrap"></p>
    </div>
  </div>

  <!-- Results Container -->
  <div id="results-container" class="hidden container mx-auto p-4 md:p-8">
    <header class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
          Extraction Results: <span id="filename" class="font-medium"></span>
        </h1>
        <div class="mt-4 flex space-x-4">
          <a id="download-json" href="#"
            class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
            Download JSON
          </a>
          <a href="/"
            class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600">
            Process More Files
          </a>
        </div>
      </div>

      <!-- Dark Mode Toggle -->
      <button id="theme-toggle" class="px-3 py-2 border rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
        Toggle Dark Mode
      </button>
    </header>

    <main id="results-content" class="space-y-12"></main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const resultId = window.location.pathname.split("/")[2];
      if (!resultId) {
        showError("No result ID found.");
        setTimeout(() => window.location.href = "/", 2000);
        return;
      }

      try {
        const response = await fetch(`/api/results/${resultId}`);
        if (!response.ok) throw new Error((await response.json()).detail);
        const result = await response.json();
        renderPage(result, resultId);
      } catch (err) {
        showError(err.message);
      }
    });

    // Dark mode toggle
    document.getElementById("theme-toggle").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      localStorage.setItem(
        "theme",
        document.documentElement.classList.contains("dark") ? "dark" : "light"
      );
    });

    function renderPage(result, resultId) {
      document.getElementById("filename").textContent = result.filename;
      document.getElementById("download-json").href = `/api/download/json/${resultId}`;

      const resultsContent = document.getElementById("results-content");
      resultsContent.innerHTML = "";

      if (!result.data || Object.keys(result.data).length === 0) {
        resultsContent.innerHTML = "<p>No data extracted.</p>";
      } else {
        for (const billName in result.data) {
          resultsContent.appendChild(renderBill(billName, result.data[billName], resultId));
        }
      }

      document.getElementById("loading").classList.add("hidden");
      document.getElementById("results-container").classList.remove("hidden");
    }

    function renderBill(billName, billData, resultId) {
      const billSection = document.createElement("section");
      billSection.className = "p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg";

      const billTitle = document.createElement("h2");
      billTitle.className = "text-2xl font-bold mb-6 border-b border-gray-200 dark:border-gray-700 pb-4";
      billTitle.textContent = billName.replace(/_/g, " ");
      billSection.appendChild(billTitle);

      const layoutGrid = document.createElement("div");
      layoutGrid.className = "grid grid-cols-1 lg:grid-cols-3 gap-8";
      billSection.appendChild(layoutGrid);

      // Image column
      const imageCol = document.createElement("div");
      imageCol.className = "lg:col-span-1 lg:sticky lg:top-8 self-start";
      if (billData.page_images?.length) {
        imageCol.appendChild(renderImageViewer(billData.page_images));
      }
      layoutGrid.appendChild(imageCol);

      // Data column
      const dataCol = document.createElement("div");
      dataCol.className = "lg:col-span-2";
      layoutGrid.appendChild(dataCol);

      const { keyValues, tablesFromJSON } = separateJsonData(billData.json_data || {});
      if (Object.keys(keyValues).length) {
        dataCol.appendChild(createSectionTitle("Extracted Fields"));
        dataCol.appendChild(createKeyValueDisplay(keyValues));
      }
      for (const tableName in tablesFromJSON) {
        dataCol.appendChild(createSectionTitle(tableName));
        dataCol.appendChild(createTableFromData(tablesFromJSON[tableName]));
      }

      if (billData.data_tables?.length) {
        dataCol.appendChild(createSectionTitle("Detected Document Tables"));
        billData.data_tables.forEach((tableData, index) => {
          const downloadUrl = `/api/download/excel/${resultId}/${billName}/${index}`;
          dataCol.appendChild(createTableFromData(tableData, `Table ${index + 1}`, downloadUrl));
        });
      }

      return billSection;
    }

    function renderImageViewer(imageUrls) {
      const container = document.createElement("div");
      const mainImage = document.createElement("img");
      mainImage.src = imageUrls[0];
      mainImage.className = "w-full rounded-lg shadow-md border dark:border-gray-700";
      container.appendChild(mainImage);

      if (imageUrls.length > 1) {
        const thumbnailContainer = document.createElement("div");
        thumbnailContainer.className = "mt-4 grid grid-cols-4 md:grid-cols-5 gap-2";

        imageUrls.forEach((url, index) => {
          const thumb = document.createElement("img");
          thumb.src = url;
          thumb.className = "w-full h-auto rounded thumbnail";
          if (index === 0) thumb.classList.add("active");

          thumb.addEventListener("click", () => {
            mainImage.src = url;
            thumbnailContainer.querySelectorAll(".thumbnail").forEach(t => t.classList.remove("active"));
            thumb.classList.add("active");
            thumb.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "nearest" });
          });

          thumbnailContainer.appendChild(thumb);
        });

        container.appendChild(thumbnailContainer);
      }
      return container;
    }

    function separateJsonData(jsonData) {
      const keyValues = {}, tablesFromJSON = {};
      for (const key in jsonData) {
        if (Array.isArray(jsonData[key]) && jsonData[key].length && typeof jsonData[key][0] === "object") {
          tablesFromJSON[key] = jsonData[key];
        } else {
          keyValues[key] = jsonData[key];
        }
      }
      return { keyValues, tablesFromJSON };
    }

    function createSectionTitle(title) {
      const h4 = document.createElement("h4");
      h4.className = "text-xl font-semibold mt-4 mb-3 border-b border-gray-200 dark:border-gray-700 pb-2";
      h4.textContent = title;
      return h4;
    }

    function createKeyValueDisplay(data) {
      const container = document.createElement("div");
      container.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
      for (const key in data) {
        const value = data[key];
        const item = document.createElement("div");
        item.className = "p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg";
        item.innerHTML += `<p class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-1">${key}</p>`;
        if (typeof value === "object" && value !== null && !Array.isArray(value)) {
          item.appendChild(createKeyValueDisplay(value));
        } else {
          item.innerHTML += `<p class="text-base font-medium break-words">${value ?? ""}</p>`;
        }
        container.appendChild(item);
      }
      return container;
    }

    function createTableFromData(tableData, captionText, downloadUrl) {
      const container = document.createElement("div");
      container.className = "mb-6";

      const header = document.createElement("div");
      header.className = "flex justify-between items-center mb-2";
      if (captionText) header.innerHTML += `<p class="text-lg font-medium">${captionText}</p>`;
      if (downloadUrl) header.innerHTML += `<a href="${downloadUrl}" class="px-3 py-1 bg-teal-600 text-white text-xs font-semibold rounded-full hover:bg-teal-700">Download Excel</a>`;
      container.appendChild(header);

      if (!tableData?.length || typeof tableData[0] !== "object") {
        container.innerHTML += `<p class="text-gray-500 italic p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">No valid data for this table.</p>`;
        return container;
      }

      const tableWrapper = document.createElement("div");
      tableWrapper.className = "overflow-x-auto rounded-lg border dark:border-gray-700";

      const table = document.createElement("table");
      table.className = "min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm";

      const headers = Object.keys(tableData[0]);
      table.innerHTML = `
        <thead class="bg-gray-50 dark:bg-gray-700">
          <tr>${headers.map(h => `<th class="px-4 py-2 text-left font-medium">${h}</th>`).join("")}</tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          ${tableData.map(row => `
            <tr>${headers.map(h => `<td class="px-4 py-2 break-words">${row[h] ?? ""}</td>`).join("")}</tr>
          `).join("")}
        </tbody>
      `;

      tableWrapper.appendChild(table);
      container.appendChild(tableWrapper);
      return container;
    }

    function showError(message) {
      document.getElementById("loading").classList.add("hidden");
      document.getElementById("results-container").classList.add("hidden");
      const errorContainer = document.getElementById("error-container");
      errorContainer.querySelector("#error-message").textContent = message;
      errorContainer.classList.remove("hidden");
    }
  </script>
</body>
</html>
