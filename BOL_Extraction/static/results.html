<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Extraction Results</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="/static/style.css">

  <style>
    /* Scoped styles for the results page to avoid conflicts */
    body {
        background-color: #f8fafc; /* Match the main content background */
    }
    /* Image viewer styles adapted for the new theme */
    .viewer {
      position: relative;
      width: 100%;
      overflow: hidden;
      border-radius: 0.5rem;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }
    .viewer img.main-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      user-select: none;
      -webkit-user-drag: none;
      transform-origin: 0 0;
      transition: transform .16s ease;
      will-change: transform;
    }
    .viewer.grabbing { cursor: grabbing; }
    .thumbnail {
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 0.5rem;
      object-fit: cover;
      transition: border-color 0.2s;
    }
    .thumbnail:hover { border-color: #d1d5db; }
    .thumbnail.active { border-color: #2563eb; }

    /* Table styles adapted to the new theme */
    .table-wrap {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      overflow: auto;
    }
    .responsive-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .responsive-table thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #1f2a43; /* gray-50 */
      color: #f2f4f6; /* gray-700 */
      font-weight: 600;
      text-align: left;
      padding: .75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .responsive-table td {
      padding: .75rem 1rem;
      text-align: left;
      word-break: break-word;
      border-bottom: 1px solid #e5e7eb;
    }
    .responsive-table tbody tr:last-child td {
        border-bottom: none;
    }
    .responsive-table tbody tr:nth-child(even) { background: #f9fafb; }
  </style>
</head>

<body>
  <!-- Loading -->
  <div id="loading" class="flex justify-center items-center h-screen">
    <div class="text-center">
      <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      <p class="mt-2 text-lg text-gray-600">Loading Results...</p>
    </div>
  </div>

  <!-- Error -->
  <div id="error-container" class="hidden container mx-auto p-6">
    <div class="surface p-6">
      <h2 class="text-xl font-bold mb-2 text-red-700">Error</h2>
      <p id="error-message" class="whitespace-pre-wrap text-gray-600"></p>
    </div>
  </div>

  <!-- Results -->
  <div id="results-container" class="hidden p-4 md:p-8">
    <header class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <h1 class="text-3xl font-bold text-gray-800">
            Extraction Results: <span id="filename" class="font-medium text-gray-500"></span>
            </h1>
            <div class="flex gap-3 mt-4 md:mt-0">
            <a id="download-json" href="#" class="btn btn-success">Download JSON</a>
            <a href="/" class="btn btn-primary">Process More Files</a>
            </div>
        </div>
    </header>

    <main id="results-content" class="space-y-8"></main>
  </div>

  <script>
    /* ==================== FETCH & RENDER ==================== */
    document.addEventListener('DOMContentLoaded', async () => {
      const resultId = window.location.pathname.split('/')[2];
      if (!resultId) { showError("No result ID found."); return; }
      try {
        const res = await fetch(`/api/results/${resultId}`);
        if (!res.ok) throw new Error((await res.json()).detail);
        const result = await res.json();
        renderPage(result, resultId);
      } catch (e) {
        showError(e.message);
      }
    });

    function renderPage(result, resultId){
      document.getElementById('filename').textContent = result.filename;
      document.getElementById('download-json').href = `/api/download/json/${resultId}`;

      const host = document.getElementById('results-content');
      host.innerHTML = '';

      if (!result.data || Object.keys(result.data).length === 0) {
        host.innerHTML = '<div class="surface p-4">No data extracted.</div>';
      } else {
        for (const billName in result.data) {
          host.appendChild(renderBill(billName, result.data[billName], resultId, result.filename));
        }
      }

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('results-container').classList.remove('hidden');
    }

    function renderBill(billName, billData, resultId, filename){
      const section = document.createElement('section');
      section.className = 'surface p-6';

      /* Header */
      const head = document.createElement('div');
      head.className = 'pb-4 border-b border-gray-200 flex items-center justify-between';
      const title = document.createElement('h2');
      title.className = 'text-2xl font-bold text-gray-800';
      title.textContent = billName.replace(/_/g, ' ');
      head.appendChild(title);

      if (billData.required_json){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-primary';
        btn.textContent = 'Bill JSON Data';
        btn.addEventListener('click', () => {
          const dataStr = JSON.stringify(billData.required_json, null, 2);
          const blob = new Blob([dataStr], { type:'application/json' });
          const url = URL.createObjectURL(blob);
          const safeFile = (filename||'result').replace(/[^a-z0-9._-]+/gi,'_');
          const safeBill = billName.replace(/[^a-z0-9._-]+/gi,'_');
          const a = document.createElement('a');
          a.href = url; a.download = `${safeFile}_${safeBill}_required.json`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });
        head.appendChild(btn);
      }
      section.appendChild(head);

        /* ---------------- 40/60 layout ---------------- */
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 xl:grid-cols-5 gap-6 mt-6';
        section.appendChild(grid);

        /* Left 40%: Image viewer (sticky for long tables) */
        const left = document.createElement('div');
        left.className = 'xl:sticky xl:top-8 self-start xl:col-span-2';
        if (billData.page_images?.length) {
            left.appendChild(renderImageViewer(billData.page_images));
        }
        grid.appendChild(left);

        /* Right 60%: Extracted Fields + Tables */
        const right = document.createElement('div');
        right.className = 'space-y-6 xl:col-span-3';
        grid.appendChild(right);


      const { keyValues } = separateJsonData(billData.json_data || {});
      delete keyValues["Carrier Information"];
      delete keyValues["Customer Order Information"];

      if (Object.keys(keyValues).length){
        right.appendChild(makeSectionTitle('Extracted Fields'));
        right.appendChild(createKeyValueDisplay(keyValues));
      }

      if (billData.data_tables?.length){
        right.appendChild(makeSectionTitle('Detected Document Tables'));
        billData.data_tables.forEach((tbl, idx) => {
          const url = `/api/download/excel/${resultId}/${billName}/${idx}`;
          right.appendChild(createTableFromData(tbl, `Table ${idx+1}`, url));
        });
      }

      return section;
    }

    /* ==================== IMAGE VIEWER ==================== */
    function renderImageViewer(imageUrls){
      const container = document.createElement('div');

      const viewer = document.createElement('div');
      viewer.className = 'viewer';
      container.appendChild(viewer);

      const main = document.createElement('img');
      main.src = imageUrls[0];
      main.className = 'main-image';
      main.alt = 'Document page';
      viewer.appendChild(main);

      if (imageUrls.length > 1) {
        const thumbs = document.createElement('div');
        thumbs.className = 'mt-4 grid grid-cols-4 md:grid-cols-5 gap-2';
        imageUrls.forEach((url, i) => {
          const t = document.createElement('img');
          t.src = url; t.className = 'thumbnail';
          if (i===0) t.classList.add('active');
          t.addEventListener('click', () => {
            main.src = url; resetZoom();
            thumbs.querySelectorAll('.thumbnail').forEach(e => e.classList.remove('active'));
            t.classList.add('active');
          });
          thumbs.appendChild(t);
        });
        container.appendChild(thumbs);
      }

      function sizeViewer(){
        const nw = main.naturalWidth || 0, nh = main.naturalHeight || 0;
        if (!nw || !nh) return;
        const w = viewer.clientWidth, ratio = nh / nw;
        const desired = Math.min(w * ratio, 760);
        viewer.style.height = desired + 'px';
      }

      main.addEventListener('load', () => { sizeViewer(); clamp(); apply(); });
      window.addEventListener('resize', () => { sizeViewer(); clamp(); apply(); });
      setTimeout(sizeViewer, 0);

      let scale=1, zoomed=false, tx=0, ty=0, drag=null;
      const Z=2;

      function apply(){ main.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`; }
      function bounds(s){
        const v = viewer.getBoundingClientRect(), i = main.getBoundingClientRect();
        const w = i.width * s, h = i.height * s;
        return { minX: Math.min(0, v.width - w), maxX: 0, minY: Math.min(0, v.height - h), maxY: 0 };
      }
      function clamp(){ const b = bounds(scale); tx = Math.max(b.minX, Math.min(b.maxX, tx)); ty = Math.max(b.minY, Math.min(b.maxY, ty)); }
      function resetZoom(){ scale=1; zoomed=false; tx=0; ty=0; apply(); }

      viewer.addEventListener('dblclick', (e)=>{
        e.preventDefault();
        const r = main.getBoundingClientRect(), cx = e.clientX - r.left, cy = e.clientY - r.top;
        if (!zoomed) {
          const s = Z, b = bounds(s);
          tx = Math.max(b.minX, Math.min(b.maxX, -cx * (s-1)));
          ty = Math.max(b.minY, Math.min(b.maxY, -cy * (s-1)));
          scale = s; zoomed = true;
        } else { resetZoom(); }
        apply();
      });

      viewer.addEventListener('pointerdown', (e)=>{
        if (!zoomed) return;
        e.preventDefault(); viewer.classList.add('grabbing');
        drag = { x:e.clientX, y:e.clientY, tx, ty };
        try{ viewer.setPointerCapture(e.pointerId); }catch(_){}
      });
      viewer.addEventListener('pointermove', (e)=>{
        if (!drag) return;
        e.preventDefault();
        const dx = e.clientX - drag.x, dy = e.clientY - drag.y, b = bounds(scale);
        tx = Math.max(b.minX, Math.min(b.maxX, drag.tx + dx));
        ty = Math.max(b.minY, Math.min(b.maxY, drag.ty + dy));
        apply();
      });
      function endDrag(e){ if(!drag) return; drag=null; viewer.classList.remove('grabbing'); try{ viewer.releasePointerCapture(e.pointerId); }catch(_){ } }
      viewer.addEventListener('pointerup', endDrag);
      viewer.addEventListener('pointercancel', endDrag);
      viewer.addEventListener('pointerleave', endDrag);

      return container;
    }

    /* ==================== HELPERS ==================== */
    function separateJsonData(jsonData){
      const keyValues={}, tables={};
      for (const k in jsonData) {
        if (Array.isArray(jsonData[k]) && jsonData[k].length && typeof jsonData[k][0] === 'object') {
          tables[k] = jsonData[k];
        } else {
          keyValues[k] = jsonData[k];
        }
      }
      return { keyValues, tables };
    }

    function makeSectionTitle(text){
      const h = document.createElement('h4');
      h.className = 'text-xl font-semibold text-gray-700';
      h.textContent = text;
      return h;
    }

    function createKeyValueDisplay(data){
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
      for (const key in data) {
        const value = data[key];
        const item = document.createElement('div');
        item.className = 'bg-gray-50 p-3 rounded-md border border-gray-200';
        item.innerHTML += `<p class="text-sm font-semibold mb-1 text-gray-500">${key}</p>`;
        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
          item.appendChild(createKeyValueDisplay(value));
        } else {
          item.innerHTML += `<p class="text-base font-medium break-words text-gray-800">${(value === null || value === '') ? '—' : value}</p>`;
        }
        grid.appendChild(item);
      }
      return grid;
    }

    function createTableFromData(tableData, captionText, downloadUrl){
      const container = document.createElement('div');
      container.className = 'space-y-3';

      const header = document.createElement('div');
      header.className = 'flex items-center justify-between';
      if (captionText) header.innerHTML += `<p class="font-semibold text-gray-700">${captionText}</p>`;
      if (downloadUrl) {
          const downloadLink = document.createElement('a');
          downloadLink.href = downloadUrl;
          downloadLink.className = 'btn btn-primary text-xs';
          downloadLink.textContent = 'Download Excel';
          header.appendChild(downloadLink);
      }
      container.appendChild(header);

      if (!tableData || !tableData.length || typeof tableData[0] !== 'object') {
        const msg = document.createElement('div');
        msg.className = 'surface p-4 italic text-gray-500';
        msg.textContent = 'No valid data for this table.';
        container.appendChild(msg);
        return container;
      }

      const wrap = document.createElement('div');
      wrap.className = 'table-wrap';
      const table = document.createElement('table');
      table.className = 'responsive-table';

      const headers = Object.keys(tableData[0]);
      table.innerHTML =
        `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>` +
        `<tbody>${tableData.map(row => `<tr>${headers.map(h => `<td>${(row[h]==null || row[h]==='') ? '' : row[h]}</td>`).join('')}</tr>`).join('')}</tbody>`;

      wrap.appendChild(table);
      container.appendChild(wrap);
      return container;
    }

    function showError(message){
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('results-container').classList.add('hidden');
      const box = document.getElementById('error-container');
      box.querySelector('#error-message').textContent = message;
      box.classList.remove('hidden');
    }
  </script>
</body>
</html>
