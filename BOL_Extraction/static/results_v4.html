<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraction Results</title>
    <!-- Keep CDN links valid -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { font-size: 70%; }
        body { font-family: 'Inter', sans-serif; }
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            table-layout: fixed;
        }
        .responsive-table th, .responsive-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
            word-break: break-word;
        }
        html.dark .responsive-table th, html.dark .responsive-table td { border-color: #4a5568; }
        .thumbnail {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            border-radius: 6px;
            object-fit: cover;
        }
        .thumbnail.active { border-color: #3b82f6; }

        /* --- Image viewer (only change) --- */
        .viewer {
            position: relative;
            width: 100%;
            /* height is set dynamically to keep the same shape as the image */
            overflow: hidden;           /* clip panning */
            border-radius: 0.5rem;
            border: 1px solid rgba(0,0,0,0.08);
            background: white;
        }
        html.dark .viewer { background: #0f172a; border-color: #334155; }
        .viewer img.main-image {
            position: absolute;
            top: 0; left: 0;
            width: 100%;     /* fit container width */
            height: auto;    /* preserve shape */
            user-select: none;
            -webkit-user-drag: none;
            transform-origin: 0 0;   /* translateX/Y + scale based on top-left */
            transition: transform 0.16s ease;
            will-change: transform;
        }
        .viewer.grabbing { cursor: grabbing; }
    </style>
    <script>
        /* Keep your original dark-mode boot logic */
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-2 text-lg">Loading Results...</p>
        </div>
    </div>

    <div id="error-container" class="hidden container mx-auto p-8">
        <div class="my-6 p-4 bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 rounded-lg">
            <h2 class="font-bold">Error</h2>
            <p id="error-message" class="whitespace-pre-wrap"></p>
        </div>
    </div>

    <div id="results-container" class="hidden container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Extraction Results: <span id="filename" class="font-medium"></span></h1>
            <div class="mt-4 flex space-x-4">
                <a id="download-json" href="#" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">Download JSON</a>
                <a href="/" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600">Process More Files</a>
            </div>
        </header>
        <main id="results-content" class="space-y-12"></main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const resultId = window.location.pathname.split('/')[2];
            if (!resultId) { showError("No result ID found."); return; }
            
            try {
                const response = await fetch(`/api/results/${resultId}`);
                if (!response.ok) throw new Error((await response.json()).detail);
                
                const result = await response.json();
                renderPage(result, resultId);
            } catch (err) {
                showError(err.message);
            }
        });

        function renderPage(result, resultId) {
            document.getElementById('filename').textContent = result.filename;
            document.getElementById('download-json').href = `/api/download/json/${resultId}`;
            
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '';
            
            if (!result.data || Object.keys(result.data).length === 0) {
                resultsContent.innerHTML = '<p>No data extracted.</p>';
            } else {
                for (const billName in result.data) {
                    resultsContent.appendChild(renderBill(billName, result.data[billName], resultId));
                }
            }
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
        }

        function renderBill(billName, billData, resultId) {
            const billSection = document.createElement('section');
            billSection.className = 'p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg';
            
            const billTitle = document.createElement('h2');
            billTitle.className = 'text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 border-b border-gray-200 dark:border-gray-700 pb-4';
            billTitle.textContent = billName.replace(/_/g, ' ');
            billSection.appendChild(billTitle);

            const layoutGrid = document.createElement('div');
            layoutGrid.className = 'grid grid-cols-1 lg:grid-cols-3 gap-8';
            billSection.appendChild(layoutGrid);

            const imageCol = document.createElement('div');
            imageCol.className = 'lg:col-span-1 lg:sticky lg:top-8 self-start';
            if (billData.page_images && billData.page_images.length > 0) {
                imageCol.appendChild(renderImageViewer(billData.page_images));
            }
            layoutGrid.appendChild(imageCol);

            const dataCol = document.createElement('div');
            dataCol.className = 'lg:col-span-2';
            layoutGrid.appendChild(dataCol);

            const { keyValues, tablesFromJSON } = separateJsonData(billData.json_data || {});
            // Remove Carrier Information and Customer Order Information from keyValues
            delete keyValues["Carrier Information"];
            delete keyValues["Customer Order Information"];

            if (Object.keys(keyValues).length > 0) {
                dataCol.appendChild(createSectionTitle('Extracted Fields'));
                dataCol.appendChild(createKeyValueDisplay(keyValues));
            }
            // for (const tableName in tablesFromJSON) {
            //     dataCol.appendChild(createSectionTitle(tableName));
            //     dataCol.appendChild(createTableFromData(tablesFromJSON[tableName]));
            // }

            if (billData.data_tables?.length > 0) {
                dataCol.appendChild(createSectionTitle('Detected Document Tables'));
                billData.data_tables.forEach((tableData, index) => {
                    const downloadUrl = `/api/download/excel/${resultId}/${billName}/${index}`;
                    dataCol.appendChild(createTableFromData(tableData, `Table ${index + 1}`, downloadUrl));
                });
            }

            return billSection;
        }

        /* ====== ONLY THIS PART CHANGED: Image viewer with original shape + dblclick zoom + pan ====== */
        function renderImageViewer(imageUrls) {
            const container = document.createElement('div');

            // Viewer box that keeps the same shape as the image (height set after image loads)
            const viewer = document.createElement('div');
            viewer.className = 'viewer';
            container.appendChild(viewer);

            // The main image (absolutely positioned inside viewer)
            const mainImage = document.createElement('img');
            mainImage.src = imageUrls[0];
            mainImage.className = 'main-image rounded-lg';
            mainImage.alt = 'Document page';
            viewer.appendChild(mainImage);

            // thumbnails if multiple
            if (imageUrls.length > 1) {
                const thumbnailContainer = document.createElement('div');
                thumbnailContainer.className = 'thumbs mt-4 grid grid-cols-4 md:grid-cols-5 gap-2';
                imageUrls.forEach((url, index) => {
                const thumb = document.createElement('img');
                thumb.src = url;
                thumb.className = 'thumbnail';
                if (index === 0) thumb.classList.add('active');
                thumb.addEventListener('click', () => {
                    // switch main image and reset zoom/pan
                    mainImage.src = url;
                    resetZoom();
                    thumbnailContainer.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                });
                thumbnailContainer.appendChild(thumb);
                });
                container.appendChild(thumbnailContainer);
            }

            /* --- maintain viewer height to match image shape --- */
            function sizeViewerToImage() {
                // Use natural dimensions to preserve aspect ratio
                const nw = mainImage.naturalWidth || 0;
                const nh = mainImage.naturalHeight || 0;
                if (!nw || !nh) return;

                const w = viewer.clientWidth;           // current viewer width
                const ratio = nh / nw;
                viewer.style.height = (w * ratio) + 'px';
            }

            // Recompute on load and on resize
            mainImage.addEventListener('load', () => {
                sizeViewerToImage();
                // If still zoomed when switching image, clamp inside bounds
                clampWithinBounds();
                applyTransform();
            });
            window.addEventListener('resize', () => {
                sizeViewerToImage();
                clampWithinBounds();
                applyTransform();
            });
            // initial sizing after first layout
            setTimeout(sizeViewerToImage, 0);

            /* --- dblclick zoom (toggle) + drag to pan --- */
            let scale = 1;
            let isZoomed = false;
            let tx = 0, ty = 0; // translate offsets
            let dragStart = null; // {x,y,tx,ty}

            const ZOOM_FACTOR = 2;     // zoom level when toggling in
            const MIN_SCALE = 1;

            function applyTransform() {
                mainImage.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
            }

            function getBoundsForScale(s) {
                // How far can we pan without exposing blank space?
                const vRect = viewer.getBoundingClientRect();
                const imgRect = mainImage.getBoundingClientRect();
                // displayed size before transform (img styled width is viewer width)
                const displayedW = imgRect.width;
                const displayedH = imgRect.height;

                const scaledW = displayedW * s;
                const scaledH = displayedH * s;

                const minX = Math.min(0, vRect.width - scaledW);
                const maxX = 0;
                const minY = Math.min(0, vRect.height - scaledH);
                const maxY = 0;
                return { minX, maxX, minY, maxY };
            }

            function clampWithinBounds() {
                const b = getBoundsForScale(scale);
                tx = Math.max(b.minX, Math.min(b.maxX, tx));
                ty = Math.max(b.minY, Math.min(b.maxY, ty));
            }

            function resetZoom() {
                scale = 1;
                isZoomed = false;
                tx = 0; ty = 0;
                applyTransform();
            }

            // Double-click to zoom centered at clicked point (relative to image)
            viewer.addEventListener('dblclick', (ev) => {
                ev.preventDefault();
                const imgRect = mainImage.getBoundingClientRect();
                const cx = ev.clientX - imgRect.left; // click X within image (display coords)
                const cy = ev.clientY - imgRect.top;  // click Y within image

                if (!isZoomed) {
                    const s = ZOOM_FACTOR;
                    // translate so clicked point stays under the same viewer location:
                    // tx = - cx * (s - 1), ty = - cy * (s - 1)
                    let desiredX = -cx * (s - 1);
                    let desiredY = -cy * (s - 1);
                    const b = getBoundsForScale(s);
                    tx = Math.max(b.minX, Math.min(b.maxX, desiredX));
                    ty = Math.max(b.minY, Math.min(b.maxY, desiredY));
                    scale = s;
                    isZoomed = true;
                } else {
                    resetZoom();
                }
                applyTransform();
            });

            // Drag to pan (only when zoomed)
            viewer.addEventListener('pointerdown', (ev) => {
                if (!isZoomed) return;
                ev.preventDefault();
                viewer.classList.add('grabbing');
                dragStart = { x: ev.clientX, y: ev.clientY, tx, ty };
                try { viewer.setPointerCapture(ev.pointerId); } catch(e) {}
            });
            viewer.addEventListener('pointermove', (ev) => {
                if (!dragStart) return;
                ev.preventDefault();
                const dx = ev.clientX - dragStart.x;
                const dy = ev.clientY - dragStart.y;
                const b = getBoundsForScale(scale);
                tx = Math.max(b.minX, Math.min(b.maxX, dragStart.tx + dx));
                ty = Math.max(b.minY, Math.min(b.maxY, dragStart.ty + dy));
                applyTransform();
            });
            function endDrag(ev) {
                if (!dragStart) return;
                dragStart = null;
                viewer.classList.remove('grabbing');
                try { viewer.releasePointerCapture(ev.pointerId); } catch(e) {}
            }
            viewer.addEventListener('pointerup', endDrag);
            viewer.addEventListener('pointercancel', endDrag);
            viewer.addEventListener('pointerleave', endDrag);

            return container;
        }
        /* ====== end of image viewer change ====== */

        function separateJsonData(jsonData) {
            const keyValues = {}, tablesFromJSON = {};
            for (const key in jsonData) {
                if (Array.isArray(jsonData[key]) && jsonData[key].length > 0 && typeof jsonData[key][0] === 'object') {
                    tablesFromJSON[key] = jsonData[key];
                } else {
                    keyValues[key] = jsonData[key];
                }
            }
            return { keyValues, tablesFromJSON };
        }

        function createSectionTitle(title) {
             const h4 = document.createElement('h4');
            h4.className = 'text-xl font-semibold mt-4 mb-3 text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 pb-2';
            h4.textContent = title;
            return h4;
        }

        function createKeyValueDisplay(data) {
            const container = document.createElement('div');
            container.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            for (const key in data) {
                const value = data[key];
                const item = document.createElement('div');
                item.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg';
                item.innerHTML += `<p class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-1">${key}</p>`;
                if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                    item.appendChild(createKeyValueDisplay(value));
                } else {
                    item.innerHTML += `<p class="text-base font-medium text-gray-900 dark:text-white break-words">${(value === null || value === '') ? '' : value}</p>`;
                }
                container.appendChild(item);
            }
            return container;
        }

        function createTableFromData(tableData, captionText, downloadUrl) {
            const container = document.createElement('div');
            container.className = 'mb-6';
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-2';
            if (captionText) { header.innerHTML += `<p class="text-lg font-medium">${captionText}</p>`; }
            if (downloadUrl) { header.innerHTML += `<a href="${downloadUrl}" class="px-3 py-1 bg-teal-600 text-white text-xs font-semibold rounded-full hover:bg-teal-700 transition">Download Excel</a>`; }
            container.appendChild(header);
            if (!tableData || tableData.length === 0 || typeof tableData[0] !== 'object') {
                container.innerHTML += `<p class="text-gray-500 italic p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">No valid data for this table.</p>`;
                return container;
            }
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'overflow-x-auto rounded-lg border dark:border-gray-700';
            const table = document.createElement('table');
            table.className = 'responsive-table';
            const headers = Object.keys(tableData[0]);
            table.innerHTML = `<thead><tr class="bg-gray-50 dark:bg-gray-700">${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                             <tbody>${tableData.map(row => `<tr>${headers.map(h => `<td>${(row[h] === null || row[h] === '') ? '' : row[h]}</td>`).join('')}</tr>`).join('')}</tbody>`;
            tableWrapper.appendChild(table);
            container.appendChild(tableWrapper);
            return container;
        }
        
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results-container').classList.add('hidden');
            const errorContainer = document.getElementById('error-container');
            errorContainer.querySelector('#error-message').textContent = message;
            errorContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>
